<app-navigation
  class="pcoded-navbar"
  [ngClass]="{
    'navbar-collapsed': navCollapsed,
    'mob-open': navCollapsedMob
  }"
  (NavCollapse)="navCollapsed = !navCollapsed"
  (NavCollapsedMob)="navMobClick()"
></app-navigation>

<div class="pcoded-main-container">
  <div class="pcoded-wrapper">
    <div class="pcoded-content">
      <div class="pcoded-inner-content">
        <div class="container mt-4">
          <!-- Bouton de retour -->
          <div class="header-container d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Messages de la Discussion</h2>
            <button class="btn btn-primary" (click)="goBack()">
              <i class="fas fa-arrow-left"></i> Retour
            </button>
          </div>

          <!-- Bouton pour ouvrir le formulaire -->
          <button class="btn btn-success mb-4" (click)="toggleForm()">
            <i class="fas fa-plus"></i> Ajouter un message
          </button>

          <!-- Liste des messages en grille -->
          <div class="messages-grid">
            <div *ngFor="let message of messages" class="message-card">
              <!-- Image du message -->
              <div *ngIf="message.image" class="text-center mt-3">
                <img
                  [src]="'http://localhost:8089/images/' + message.image"
                  alt="Image du message"
                  class="message-image"
                />
              </div>

              <!-- Corps de la carte -->
              <div class="card-body text-center">
                <!-- Détails du message -->
                <h5 class="card-title mb-2">{{ message.userId || 'Inconnu' }}</h5>
                <small class="text-muted">{{ message.messageDate | date: 'd MMM, y' }}</small>
                <p class="card-text mt-2">{{ message.description || 'Aucune description' }}</p>

                <!-- Boutons Modifier et Supprimer -->
                <div class="d-flex justify-content-center mt-3">
                  <button
                    class="btn btn-sm btn-warning me-2"
                    (click)="editMessage(message.message_id, message.description, message.image)"
                  >
                    <i class="fas fa-edit"></i> Modifier
                  </button>
                  <button
                    class="btn btn-sm btn-danger"
                    (click)="deleteMessage(message.message_id)"
                  >
                    <i class="fas fa-trash"></i> Supprimer
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sidebar pour le formulaire d'ajout/modification de message -->
<div class="sidebar" [class.active]="showForm">
  <div class="sidebar-header">
    <h5>{{ isEditMode ? 'Modifier le message' : 'Ajouter un message' }}</h5>
    <button type="button" class="btn-close" (click)="toggleForm()"></button>
  </div>
  <div class="sidebar-body">
    <form>
      <!-- Champ de description -->
      <textarea
        class="form-control mb-3"
        [(ngModel)]="currentMessageDescription"
        placeholder="Entrez votre message..."
        rows="3"
      ></textarea>

      <!-- Champ pour sélectionner une image -->
      <input
        type="file"
        class="form-control mb-3"
        (change)="isEditMode ? onEditFileSelected($event) : onFileSelected($event)"
        accept="image/*"
      />

      <!-- Aperçu de l'image sélectionnée -->
      <div *ngIf="isEditMode ? editSelectedImage : selectedImage" class="mb-3">
        <img
          [src]="isEditMode ? editSelectedImage : selectedImage"
          alt="Aperçu de l'image"
          class="img-thumbnail"
          style="max-width: 200px;"
        />
      </div>

      <!-- Bouton pour ajouter ou sauvegarder -->
      <button
        class="btn btn-success"
        (click)="isEditMode ? saveMessage() : addMessage()"
      >
        <i class="fas fa-plus"></i> {{ isEditMode ? 'Sauvegarder' : 'Ajouter' }}
      </button>
    </form>
  </div>
</div>

<!-- Overlay pour l'arrière-plan -->
<div class="overlay" [class.active]="showForm" (click)="toggleForm()"></div>

<app-configuration></app-configuration>